#!/usr/bin/env bash
# doc: Commit a push změn v bimeta repozitáři s auto-generovanou zprávou

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"
include "lib/git.sh"

BIMETA_DIR=$HOME/o2/BIDEV-MAIN_bimeta
PWD=$(pwd)

# no changes => nothing to do
cd $BIMETA_DIR      || fDie "Failed to change directory to $BIMETA_DIR."
check_repo_clean    && exit 0

echo -e "repo is not clean, proceeding with commit"

commit_message=$(pwd | awk -F'/' '{split($NF, a, "-"); printf "%s-%s: %s-%s\n", a[1], a[2], a[3], a[4]}')
commit=$( \
    printf "skip\ncommit\ncommit and push" | \
    fzf \
        --prompt="Poslat commit na bimeta?" \
        --header="commit message: '$commit_message'" )

if [[ "$commit" == *commit* ]]; then
    printInfo "$COLOR_TRY: $BIMETA_DIR: committing changes with message '$commit_message'"
    git add . || fDie "$BIMETA_DIR: Failed to stage changes."
    git commit -m "$commit_message" || fDie "$BIMETA_DIR: Failed to commit changes."
    printSuccess "$BIMETA_DIR: changes committed successfully."
else
    printWarning "$BIMETA_DIR: no changes committed."
    exit 0
fi

if [[ "$commit" == *push* ]]; then
    printInfo "$BIMETA_DIR: pushing !!!"
    git push || fDie "$BIMETA_DIR: Failed to push changes."
    printSuccess "$BIMETA_DIR: push successful."
else
    printWarning "$BIMETA_DIR: NO PUSH!"    
    read -p "Press enter to continue..."
    exit 0
fi