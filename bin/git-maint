#!/usr/bin/env bash
# doc: runs a git fsck and git repack; DO NOT KILL THIS COMMAND as the repo could be left broken

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"


# Perform regular repository maintenance
printInfo "Starting repository maintenance"

# Run git fsck to check for repository integrity
printInfo "Running git fsck to check repository integrity"
fsck_output=$(git fsck 2>&1)
if echo "$fsck_output" | grep -qE "error|fatal"; then
    printError "git fsck encountered errors:"
    echo "$fsck_output"
    fDie "Repository integrity check failed"
fi
printSuccess "git fsck completed successfully"

# # Run git repack to optimize the repository
# printInfo "Running git repack to optimize the repository"
# repack_output=$(git repack 2>&1)
# if [ $? -ne 0 ]; then
#     printError "git repack encountered errors:"
#     echo "$repack_output"
#     fDie "Repository repack failed"
# fi
# printInfo "git repack completed successfully"

# Run git repack to optimize the repository
printInfo "Running git gc to optimize the repository, do NOT KILL THIS COMMAND !!!!"
repack_output=$(git gc 2>&1)
if [ $? -ne 0 ]; then
    printError "git gc encountered errors:"
    echo "$repack_output"
    fDie "git gc failed"
fi
printSuccess "git gc completed successfully"


printSuccess "Repository maintenance completed"