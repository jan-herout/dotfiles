#!/bin/bash

MM_DEFDIR=$HOME/bin/net-mount-points
MM_PASSWORD_FILE=$HOME/Vaults/o2/domain-password.txt

# colors
MM_ERR="\e[31mERR\e[0m"
MM_TRY="\033[33mTRY\033[0m"
MM_OK="\033[34mOK\033[0m "


# kontrola existence adresáře s definicemi
echo -e "$MM_TRY: test mount points config: $MM_DEFDIR"
if [ ! -d "$MM_DEFDIR" ]; then
    echo -e "$MM_ERR: Directory does not exist: $MM_DEFDIR <directory>"
    exit 1
fi
echo -e "$MM_OK"

# kontrola existence secrets souboru
echo -e "$MM_TRY: test secrets file: $MM_PASSWORD_FILE"
if [ ! -f "$MM_PASSWORD_FILE" ]; then
    echo -e "$MM_ERR: File does not exist: $MM_PASSWORD_FILE"
    exit 1
fi

# načti secrets a další
_ME_=`whoami`
_UID_=`id -u $_ME_`
_GID_=`id -g $_ME_`


# co chceme dělat
CHOICE=$(echo "jenom umount
umount a disconnect vpn" | fzf)


# proveď umount
for MM_DEFFILE in "$MM_DEFDIR"/*; do
    echo -e "$MM_TRY: read $MM_DEFFILE"
    source $MM_DEFFILE

    if [ -d "$_MNT_" ]; then
        findmnt $_MNT_ >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo -e "$MM_TRY: unmount: $_MNT_"
            sudo umount -l $_MNT_

            if [ $? -eq 0 ]; then
                echo -e "$MM_OK: unmounted"
            else
                echo -e "$MM_ERR: error ???"
            fi

        else
            echo -e "$MM_OK: not mounted: $_SRC_"
        fi
    fi
done

if [[ "$CHOICE" =~ "umount a disconnect vpn" ]]; then
    IS_O2_CONUP=$(nmcli connection show --active | grep extvpn.o2.cz)
    if [ -z "$IS_O2_CONUP" ]; then
        echo -e "$MM_OK: disconnected"
    else
        nmcli connection down extvpn.o2.cz
    fi
fi
