#!/usr/bin/env bash
# doc: Odpojí síťové disky a volitelně i VPN spojení

source $HOME/bin/basic-func.sh
if [[ $? -eq 0 ]]; then
  flog "Sourcing succeeded"
else
  echo "Sourcing failed"
  exit 1
fi


mount_points_def_dir=$HOME/bin/net-mount-points
domain_passfile=$HOME/Vaults/o2/domain-password.txt
vpn_client="/opt/cisco/anyconnect/bin/vpn"
vpn_client_ui="vpnui"

# sanity check and cryfs
[[ -d "$mount_points_def_dir" ]] || fdie "Directory does not exist: $mount_points_def_dir"
if [[ ! -f "$domain_passfile" ]]; then
    flog "try to read: $domain_passfile" info
    cryfs $HOME/.local/share/plasma-vault/o2.enc $HOME/Vaults/o2/ || fdie "cryfs failed"
fi
[[ -f "$domain_passfile" ]] || fdie "File does not exist: $domain_passfile"

# co chceme dělat
CHOICE=$(echo "jenom umount
umount a disconnect vpn" | fzf)


# proveď umount
for mount_point in "$mount_points_def_dir"/*; do
    source $mount_point || fdie "failed to source $mount_point"
    if [[ -d "$_MNT_" ]]; then
        findmnt $_MNT_ >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            flog "unmount: $_MNT_" warning
            sudo umount -l $_MNT_
            if [[ ! $? -eq 0 ]]; then
                flog "unmount failed"
            fi
        fi
    fi
done

$HOME/bin/set-proxy-off

if [[ "$CHOICE" =~ "umount a disconnect vpn" ]]; then    
    # CISCO # is_on_vpn=$(ps aux | grep vpnui | grep -v grep | awk ' { print $2 }')
    # CISCO # if [[ ! -z "$is_on_vpn" ]]; then
    # CISCO #     flog "disconnecting VPN" warning
    # CISCO #     $vpn_client disconnect extvpn.o2.cz
    # CISCO #     killall $vpn_client_ui
    # CISCO #     if [[ -d "$HOME/.cisco" ]]; then
    # CISCO #         flog "removing dir $HOME/.cisco" warning
    # CISCO #         rm -rf "$HOME/.cisco"
    # CISCO #     fi
    # CISCO # else
    # CISCO #     flog "VPN is not connected" info
    # CISCO # fi    
    IS_O2_CONUP=$(nmcli connection show --active | grep extvpn.o2.cz)
    if [ -z "$IS_O2_CONUP" ]; then
        flog "disconnected" info
    else
        nmcli connection down extvpn.o2.cz
    fi
fi

flog "done" info