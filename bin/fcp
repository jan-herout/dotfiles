#!/bin/bash
SELECTION="__"
CONTINUE="__"
FILE_LIST=""


# z jakého repa? metadata jdou buď z VODWH nebo EDW
GITDIR=$(echo "
$HOME/o2/BIDEV-MAIN_edw/meta
$HOME/o2/BIDEV-MAIN_vodwh/metadata" | fzf --prompt="Select source directory: " --height=10)
if [[ -z "$GITDIR" ]]; then
    echo "No source directory selected. Exiting."
    exit 1
fi



PROMPT="Select files to copy (use Shift+Tab to select multiple files): ESC to finish! >"
# sestavíme seznam souborů do proměnné, oddělovačem je středník

SELECTION=$(\
    find $GITDIR -type f \
    | sed "s|^$GITDIR/||" \
    | grep -E "^(ddl|mappings)" \
    | grep -viE "(^ddl/([a-z0-9_]+)_V)|(EP_LND|EP_IND)|(\d{9})|(\.bteq$)" \
    | fzf \
        --prompt="$PROMPT" \
        --multi \
        --height=40 \
        --preview 'batcat --color=always {}' \
        --preview-window=right:60%:wrap \
        --delimiter '\n' \
        --print0 \
    | tr '\0' ';'
) 

echo "Selected files:"
echo "-----------------"
IFS=$";" read -ra FILES <<< "$SELECTION"
for FILE in "${FILES[@]}"; do 
    if [[ -z "$FILE" ]]; then
        continue
    fi
    echo "$FILE"
done

echo "Continue? (y/n)"
read -r CONTINUE
if [[ "$CONTINUE" != "y" && "$CONTINUE" != "Y" && "$CONTINUE" != "" ]]; then
    echo "Exiting without copying files."
    exit 0
fi

# iterujeme přes jednotlivé soubory
IFS=";" read -ra FILES <<< "$SELECTION"
for FILE in "${FILES[@]}"; do 
    echo $FILE
    if [[ -z "$FILE" ]]; then
        continue
    fi

    echo "Processing file: $FILE"
    
    FILE="$GITDIR/$FILE" # fzd removed the prefix
    FILE=$(realpath "$FILE")    
    FILE_NAME=$(basename "$FILE")
    
    PARENT=$(dirname "$FILE") # get the parent
    REL_PATH="${FILE#$GITDIR}"  # cesta uvnitř git_dir
    REL_PARENT="${PARENT#$GITDIR}" # cesta uvnitř gitdir, ale k parent složce

    DEST="$PWD/metadata/$REL_PARENT"
    DEST=$(echo $DEST | sed s/ddl/tables/)
    TF="$DEST/$FILE_NAME"
    mkdir -p "$DEST"
    echo cp $FILE $TF
    cp $FILE $TF
done
