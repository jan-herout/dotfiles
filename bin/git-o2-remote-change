#!/usr/bin/env bash
# doc: Změní remote origin URL a nastaví O2 proxy pro existující git repo

# colors
ERR="\e[31mERR\e[0m"
TRY="\033[33mTRY\033[0m"
OK="\033[34mOK\033[0m "


# is this a bare repo?
is_bare_repo() {
# This function looks for the existence of file named "config" in the current directory
# If the file does not exist, return 1 
# If the file exist, look for the line that (stripped) equals to "bare = true"
# If the line exist, return 0, else return 1
    echo -e "$TRY: checking if the current directory is a bare git repo"
    if [ ! -f "config" ]; then
        return 1
    fi
    if grep -q "^[[:space:]]*bare[[:space:]]*=[[:space:]]*true" config; then
        return 0
    else
        return 1
    fi
}

echo -e "$TRY: checking if the current directory is a git repo"

IS_GIT_REPO=0

# test if the curent dir is already agit repo, find .git
if [ ! -d ".git" ]; then
    echo -e "$TRY: current directory is NOT a git repo, next try it is a bare git repo"    
else
    IS_GIT_REPO=1
fi

# test if this is a bare repo
if [ $IS_GIT_REPO -eq 0 ]; then
    if is_bare_repo; then
        echo -e "$OK: current directory is a bare git repo"
        IS_GIT_REPO=1
    else
        echo -e "$ERR: current directory is NOT a bare git repo"
        exit 1
    fi
fi

# bail if this is not a repo
if [ $IS_GIT_REPO -eq 0 ]; then
    echo -e "$ERR: current directory is NOT a git repo"
    exit 1
fi


# path
PAT_FILE=$HOME/Vaults/o2/github/jan_herout_pat

# kontrola existence secrets souboru a mount vaultu
echo -e "$TRY: test secrets file: $PAT_FILE"
if [ ! -f "$PAT_FILE" ]; then
    echo -e "$TRY: File does not exist: $PAT_FILE"
    cryfs $HOME/.local/share/plasma-vault/o2.enc $HOME/Vaults/o2/
fi

# pokud ani potom neexistuje, bail
if [ ! -f "$PAT_FILE" ]; then
    echo -e "$ERR: File does not exist: $PAT_FILE"
    exit 1
fi

# split the line into name and value, separator is space
GITHUB_TOKEN=$(cat $PAT_FILE | fzf)
GITHUB_TOKEN=$(echo $GITHUB_TOKEN | cut -d' ' -f2)

if [[ -z "$GITHUB_TOKEN" ]]; then
    echo -e "$ERR: No github token provided, bail out"
    exit 1
fi


# remove the remote
git remote remove origin
if [ $? -ne 0 ]; then
    echo -e "$ERR: failed to remove origin for the repo: $GITHUB_ADDRESS"
    echo -e "$TRY: do you want to continue? Press Ctrl+C to cancel or ENTER to continue"
    read -r
fi


# test if the address is in clipboard
echo -e "$TRY: try to get address from the clipboard"
CLIPBOARD=$(xclip -o)

# test it the CLIPBOARD contains multiline string
if [[ $CLIPBOARD =~ $'\n' ]]; then
    CLIPBOARD=""    
fi
if [[ ! $CLIPBOARD =~ ^https:// ]]; then
    CLIPBOARD=""
fi
if [[ ! $CLIPBOARD =~ \.git$ ]]; then
    CLIPBOARD=""
fi
if [[ -z $CLIPBOARD ]]; then
    echo -e "$TRY: clipboard does not contain a valid github address, please provide it manually"
else
    echo -e "$OK: clipboard contains a valid github address: $CLIPBOARD"
fi

# ask the user what github address to clone
read -p "Enter the github address to clone, ENTER to use the default" GITHUB_ADDRESS
if [ -z "$GITHUB_ADDRESS" ]; then
    echo -e "$TRY: No github address provided, using address from clipboard: $CLIPBOARD"
    GITHUB_ADDRESS=$CLIPBOARD
fi

# test that the address starts with https://
if [[ ! $GITHUB_ADDRESS =~ ^https:// ]]; then
    echo -e "$ERR: Address does not start with https://"
    exit 1
fi

# test that the address ends with .git
if [[ ! $GITHUB_ADDRESS =~ \.git$ ]]; then
    echo -e "$ERR: Address does not end with .git"
    exit 1
fi

echo -e "$OK: github address provided: $GITHUB_ADDRESS"


# the address is in the form: https://github.com/jan-herout_o2cz/test-repo.git
# we need it to be in the form https://$GITHUB_TOKEN@github.com/jan-herout_o2cz/test-repo.git
GITHUB_ADDRESS=${GITHUB_ADDRESS/https:\/\//https:\/\/$GITHUB_TOKEN@}

git remote add origin $GITHUB_ADDRESS
if [ $? -ne 0 ]; then
    echo -e "$ERR: failed to add a new origin for the repo: $GITHUB_ADDRESS"        
    exit 1
fi

cat .git/config