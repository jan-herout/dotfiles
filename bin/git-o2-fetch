#!/usr/bin/env bash
# doc: Fetch změn ze všech git repozitářů v o2 a o2-feature adresářích

source $HOME/bin/basic-func.sh

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"
include "lib/git.sh"


funcfetch() {
    local BASE_DIR=$1
    # Loop through each subdirectory in the base directory
    for dir in "$BASE_DIR"/*/; do
        # Check if the directory is a Git repository
        if [ -d "$dir/.git" ]; then
            flog "$COLOR_TRY: $dir" info
            # Get all configured remote URLs
            remotes=$(git -C "$dir" remote -v)

            if [[ -n $remotes ]]; then
                # Check if any remote URL contains the string "aicentre"
                if echo "$remotes" | grep -q "aicentre"; then
                   flog "Skipping fetch for repository (remote URL contains 'aicentre'): $dir" info
                else
                    git -C "$dir" fetch
                fi
            fi
        fi
    done
}

git pum

declare -a dirs=("$HOME/o2" "$HOME/o2-feature")
for dir in "${dirs[@]}"; do
    # dvě repa řeším zvlášť
    if [ "$dir" == "$HOME/o2-feature/BIDEV-MAIN_edw" ]; then
        continue
    fi
    if [ "$dir" == "$HOME/o2-feature/BIDEV-MAIN_bimeta" ]; then
        continue
    fi    
    funcfetch $dir
done


