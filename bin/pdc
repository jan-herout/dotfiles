#!/usr/bin/env bash
set -e

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "init/rofi.sh"
include "init/exports.sh"
include "basic-func.sh"


sqlplus=/home/jan/sbin/instantclient_23_6/sqlplus
pdc_log="/tmp/pdc.log"

act_deploy="deploy"
act_frequency="settings: restart frequency"
act_concurrency="settings: concurrency"
act_delete="ctrl_key_val_store: delete last_extract_dttm records"

# varibles ...
file_to_deploy=""
numerical_value=""

action=$(
    printf "%s\n%s\n%s\n%s" "$act_deploy" "$act_frequency" "$act_concurrency" "$act_delete"| rofi-menu
)
[[ -z "$action" ]] && echo "No action selected, aborting." && exit 1

if ! command -v "$sqlplus"  &> /dev/null; then
    notify-send "sqlplus not found!"
    exit 1 
fi

flog "$action"

# If deploy action is selected, use _rofi_select_file to choose the SQL file
if [[ "$action" == "$act_deploy" ]]; then
    file_to_deploy=$(_rofi_select_file "*.sql" "$HOME/o2-feature")
    if [[ $? -ne 0 ]]; then
        echo "No file selected or error occurred, aborting deployment." >&2
        exit 1
    fi
    echo "Selected file for deployment: $file_to_deploy"
fi

# If frequency or concurrency action is selected, ask for numerical input
if [[ "$action" == "$act_frequency" ]] || [[ "$action" == "$act_concurrency" ]]; then    
    numerical_value=$(seq 0 20 | rofi-menu)
    if [[ -z "$numerical_value" ]]; then
        echo "No value entered, aborting." >&2
        exit 1
    fi    
fi

# If set concurrency, create a temp file
if [[ "$action" == "$act_concurrency" ]]; then    
    temp_sql_file=$(mktemp /tmp/set_concurrency_XXXX.sql)
    cat << EOF > "$temp_sql_file"
UPDATE ctrl_parameters
SET param_val_int = ${numerical_value}
WHERE param_name = 'MAX_CONCURRENT_JOBS'
;

commit;
EOF
    file_to_deploy="$temp_sql_file"
    flog "Setting concurrency to ${numerical_value} in file $file_to_deploy"
fi

# If delete ctrl_key_val_store, create a temp file
if [[ "$action" == "$act_delete" ]]; then    
    temp_sql_file=$(mktemp /tmp/set_delete_ctrl_kvs_XXXX.sql)
    cat << EOF > "$temp_sql_file"
        delete FROM ctrl_key_val_store WHERE store_key_name LIKE '%last_extract_dttm'
        ;
        commit
        ;
EOF
    file_to_deploy="$temp_sql_file"
    flog "Setting concurrency to ${numerical_value} in file $file_to_deploy"
fi

# If set frequency, create a temp file
if [[ "$action" == "$act_frequency" ]]; then    
    temp_sql_file=$(mktemp /tmp/set_frequency_XXXX.sql)
    cat << EOF > "$temp_sql_file"
update ctrl_job_status 
set delay_minutes = ${numerical_value} where status in (3,9)
;
EOF
    file_to_deploy="$temp_sql_file"
    flog "Setting restart frequency ${numerical_value} in file $file_to_deploy"
fi

[[ -z "$file_to_deploy" ]] && fdie "No file selected for deployment, aborting."

flog "add exit to '$file_to_deploy'"
echo "
exit;
" >> "$file_to_deploy"

[[ -z "$file_to_deploy" ]] && fdie "No file selected for deployment, aborting."


PDC="PDC_X0548834"
PASSWORD="x$PDC"
TNSNAME="BIDEVELOP"

touch "$pdc_log"
echo "$file_to_deploy" >"$pdc_log" 
cat "$file_to_deploy" >>"$pdc_log"
echo $sqlplus "$PDC/$PASSWORD@$TNSNAME" @"$file_to_deploy" >> "$pdc_log" 2>&1
$sqlplus "$PDC/$PASSWORD@$TNSNAME" @"$file_to_deploy" >> "$pdc_log" 2>&1

if [[ $? -ne 0 ]]; then    
    log_content=$(cat "$pdc_log")
    notify-send "Failed to deploy to PDC"

else
    notify-send "SUCCESS"
    rm "$pdc_log"
fi

[[ -f "$file_to_deploy" ]] && rm -f "$file_to_deploy"
