#!/bin/bash

source $HOME/bin/basic-func.sh
if [[ $? -ne 0 ]]; then
  echo "sourcing failed"
  exit 1
fi

network_username="a1548834"
linux_username=$(whoami)
var_uid=$(id -u $linux_username)
var_gid=$(id -g $linux_username)

CREDENTIALS=$HOME/Vaults/o2/o2_a1548834_cifs_credentials.txt
[[ ! -f "$CREDENTIALS" ]] && fdie "No pass provided, bail out: $CREDENTIALS"

RANDOM_NAME=$(head /dev/urandom | tr -dc 'a-zA-Z0-9' | head -c 16)
WRITABLE_CREDENTIALS="/tmp/$RANDOM_NAME"


# select the share to be mounted
MOUNTFILE=$(ls $HOME/bin/a-write-mounts | fzf --prompt="Vyber mount: ")
[[ -z "$MOUNTFILE" ]] && fdie "No mount selected, bail out"

echo "ro - read only
rw - read write" | fzf --prompt="Mount type: " --header="Choose mount type" >/dev/null 2>&1

# source the mount file and set vars
source $HOME/bin/a-write-mounts/$MOUNTFILE

# copy credentials
cp $CREDENTIALS $WRITABLE_CREDENTIALS || fdie "failed to copy credentials"
chmod 666 $WRITABLE_CREDENTIALS || fdie "failed to make credentials readable"

MOUNT_POINT=$_MNT_
SHARE_UNC=$_SRC_

findmnt $MOUNT_POINT >/dev/null 2>&1
if [ $? -eq 0 ]; then
    flog "directory is already mounted: $MOUNT_POINT" warning
else
    flog "mounting $SHARE_UNC to $MOUNT_POINT" info
    MM_OPTIONS="credentials=$WRITABLE_CREDENTIALS,"
    MM_OPTIONS+="uid=$var_uid,"
    MM_OPTIONS+="gid=$var_gid,"
    MM_OPTIONS+="dir_mode=0755,file_mode=0755"
    MM_OPTIONS+=$_SUFFIX_
    if [[ ! -d $MOUNT_POINT ]]; then
        flog "mount point does not exist, creating it"
        sudo mkdir $MOUNT_POINT
    fi
    flog "mount options: $MM_OPTIONS" info    
    sudo mount -t cifs -o "$MM_OPTIONS" "$SHARE_UNC" "$MOUNT_POINT"
    if [ $? -ne 0 ]; then
        flog "mount failed" error
        flog "- ca: https://pam.cz.o2/PasswordVault/v10/Accounts" error
        flog "- check credentials: $CREDENTIALS" error
        echo sudo mount -t cifs -o "$MM_OPTIONS" "$SHARE_UNC" "$MOUNT_POINT"

    fi
fi

# rm $WRITABLE_CREDENTIALS
