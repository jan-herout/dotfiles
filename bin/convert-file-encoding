#!/usr/bin/env bash
# doc: convert a file or bunch of files from source encoding to UTF-8
# Source basic functions
[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"

read -r -d '' USAGE <<'EOF'
convert-file: convert a file or bunch of files from source encoding to UTF-8
convert-file <input_file_or_folder> -o <output encoding>
EOF

# parse options
ARG_OUTPUT_ENCODING=""
ARG_PATH=""
while getopts "ho" opt; do
   case "${opt}" in
        h)
           echo $USAGE
           exit 0
           ;;
        o)

            ARG_OUTPUT_ENCODING="${OPTARG}"
            [[ -z "$ARG_NEW" ]] && ARG_ADD="."
            ;;
        ?)
            echo $USAGE
            exit 0
            ;;
    esac
done
shift $((OPTIND - 1))
ARG_PATH="$1"

[[ -z "$ARG_PATH" ]] && fDie "$USAGE"

ENCODINGS="utf-8
iso-8859-2
windows-1250    
utf-16
utf-32
"

if [[ -z "$ARG_OUTPUT_ENCODING" ]]; then
    ARG_OUTPUT_ENCODING=$(echo "$ENCODINGS" | fzf --prompt "Output encoding?")
    [[ -z "$ARG_OUTPUT_ENCODING" ]] && fDie "No output encoding selected."
fi


function get-encoding() {    
    local file_output
    file_output=$(file -i "$1" 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo ""
        exit 1
    fi
    
    echo "$file_output" | grep -iq 'charset=[a-z0-9-]*ascii'
    if [[ $? -eq 0 ]]; then
        echo "utf-8"
        exit 0
    fi

    echo "$file_output" | grep -iq UTF-16
    if [[ $? -eq 0 ]]; then
        echo "utf-16"
        exit 0
    fi

    echo "$file_output" | grep -iq UTF-8
    if [[ $? -eq 0 ]]; then
        echo "utf-8"
        exit 0
    fi

    echo "$file_output" | grep -iq ISO-8859-2
    if [[ $? -eq 0 ]]; then
        echo "iso-8859-2"
        exit 0
    fi

    echo "$file_output" | grep -iq ISO-8859
    if [[ $? -eq 0 ]]; then
        echo "windows-1250"
        exit 0
    fi
    echo ""
    exit 1
}

function _convert_file() {
    local file="$1"    
    local oe="$2"
    local ie=$(get-encoding "$file")
    if [[ -z "$ie" ]]; then 
        echo "unknown encoding: $file" 
        exit 1
    fi

    if [[ "$ie" == "$oe" ]]; then
        echo "file already in target encoding"
        exit 0
    fi
    

    local tempfile="$file~converted~"
    local original="$file~original~"        
    iconv --from="$ie" --to="$oe" "$file" >"$tempfile" 2>/dev/null
    [[ ! $? -eq 0 ]] && exit 1
    
    mv "$file" "$original" || exit 1    
    mv "$tempfile" "$file" || exit 1    
    rm "$original" || exit 1
    echo "$ie=>$oe: $file"    
    exit 0
}

if [[ -f "$ARG_PATH" ]]; then
    msg=$(_convert_file "$ARG_PATH" "$ARG_OUTPUT_ENCODING")
    if [[ $? -ne 0 ]]; then
        printError "$ARG_PATH to $ARG_OUTPUT_ENCODING: $msg"
    fi
fi

printInfo "Diving into $ARG_PATH"
find "$ARG_PATH" -type f | while read -r file; do     
    msg=$(_convert_file "$file" "$ARG_OUTPUT_ENCODING")
    [[ ! $? -eq 0 ]] && printError "$file: $msg" || printSuccess "$file"
done