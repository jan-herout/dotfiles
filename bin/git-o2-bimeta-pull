#!/usr/bin/env bash
# doc: Automatický pull bimeta repozitáře s time-based throttling

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"
include "lib/git.sh"

# colors
BIMETA_DIR=$HOME/o2/BIDEV-MAIN_bimeta
PWD=$(pwd)
last_update_file="/tmp/BIDEV-MAIN_bimeta-last-update.txt"
pull_interval_minutes=15

# we are using the last_update file to avoid pulling too often
# when the file is not there, we assume we need to pull
# if the file is there, we check its age, and if it's older than the pull_interval_limit, we pull

should_pull=true
if [ -f "$last_update_file" ]; then
    # Get the modification time of the last update file in seconds since epoch
    last_update_time=$(stat -c %Y "$last_update_file" 2>/dev/null)
    if [ $? -eq 0 ]; then
        # Get current time in seconds since epoch
        current_time=$(date +%s)
        
        # Calculate the time difference in seconds
        time_diff=$((current_time - last_update_time))
        
        # Convert pull_interval_minutes to seconds
        pull_interval_seconds=$((pull_interval_minutes * 60))
        
        # Check if enough time has passed
        if [ $time_diff -lt $pull_interval_seconds ]; then
            printSuccess "Last update was $(($time_diff / 60)) minutes ago. Skipping pull (interval: ${pull_interval_minutes} minutes)."
            should_pull=false
        else
            printWarn "Last update was $(($time_diff / 60)) minutes ago. Proceeding with pull."
        fi
    else
        printWarn "Could not read last update file. Proceeding with pull."
    fi
else
    printWarn "No last update file found. Proceeding with pull."
fi

# Exit early if we don't need to pull
if [ "$should_pull" = false ]; then
    exit 0
fi

printInfo "$BIMETA_DIR: checking the repo"
cd $BIMETA_DIR || fDie "Failed to change directory to BIMETA_DIR."
check_repo_clean || fDie "$BIMETA_DIR: repository is not clean."


printInfo "$BIMETA_DIR: switching to main, pulling latest changes"
git switch main || fDie "$BIMETA_DIR: Failed to switch to main branch."
git fetch || fDie "$BIMETA_DIR: Failed to fetch latest changes."
git pull --rebase || fDie "$BIMETA_DIR: Failed to pull latest changes."

# Return to original directory
cd "$PWD" || fDie "Failed to return to original directory."

# Update the last update file timestamp
printInfo "Updating last update timestamp"
touch "$last_update_file" || fDie "Failed to update last update file."

printSuccess "BIMETA repository updated successfully."



