#!/usr/bin/env bash
# doc: list all blobs and sort them by size (ascending sort); git ls -h to get help

read -r -d '' USAGE <<'EOF'
git ls: list all blobs and sort them by size (ascending sort)

Switches:
  -s <size-in-bytes>
    list only blobs that are bigger than the specified size (in bytes); e.g. 2^20 is MiB
  -m 
    produce a machine readable output instead of a human readable output
EOF


_git_ls() {  
  local size="$1"
  local readable="$2"
  git rev-list --objects --all --missing=print |
    git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' |
    sed -n 's/^blob //p' |
    sort --numeric-sort --key=2 | # cut -c 1-12,41- |
    awk "\$2 >= $size" |    
    if [[ "$readable" == true ]]; then
      $(command -v gnumfmt || echo numfmt) --field=2 --to=iec-i --suffix=B --padding=7 --round=nearest
    else
      cat
    fi
}

SIZE=0
READABLE=true
while getopts "mhes:" opt; do
   case "${opt}" in
        h)
           echo $USAGE
           exit 0
           ;;      
        s)            
            SIZE=$OPTARG
            ;;
        m)
            READABLE=false
            ;;
        ?)
           echo $USAGE
           exit 0
            ;;
    esac
done
shift $((OPTIND-1))

_git_ls "$SIZE" "$READABLE"