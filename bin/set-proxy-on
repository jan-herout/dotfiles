#!/bin/bash
[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"


is_on_vpn=$(nmcli connection show --active | grep extvpn.o2.cz)
if [[ -z "$is_on_vpn" ]]; then  
  return
fi

O2_USERNAME=""
O2_PASSWORD=""

if ! test -f ~/Vaults/o2/o2_username.txt; then
  printError "First, connect to o2 vault."
  return
fi


if ! test -f ~/Vaults/o2/o2_password.txt; then
  printError "First, connect to o2 vault."
  return
fi



O2_USERNAME=$(cat ~/Vaults/o2/o2_username.txt)
O2_PASSWORD=$(cat ~/Vaults/o2/o2_password.txt)
O2_PROXY="internet-proxy-s1.cz.o2:8080"

export http_proxy="http://$O2_USERNAME:$O2_PASSWORD@$O2_PROXY"
fake_proxy="http://$O2_USERNAME:**********@$O2_PROXY"
export https_proxy="http://$O2_USERNAME:$O2_PASSWORD@$O2_PROXY"
export HTTP_PROXY=$http_proxy
export HTTPS_PROXY=$https_proxy
export no_proxy="localhost,127.0.0.1,::1"
export NO_PROXY="localhost,127.0.0.1,::1"
printSuccess "These variables has been set: http_proxy, https_proxy, HTTP_PROXY, HTTPS_PROXY, no_proxy, NO_PROXY"
# set git proxy

# git config --global http.proxy "$http_proxy" || flog "Failed to set http_proxy: $http_proxy" error


cur_proxy=""
[[ -f $HOME/.gitproxy ]] && cur_proxy=$(cat $HOME/.gitproxy | grep proxy | awk '{ print $3 }') 

if [[ -z "$cur_proxy" ]] ; then
  rm $HOME/.gitproxy
  echo "[http]
	    proxy = $http_proxy" >$HOME/.gitproxy
  printSuccess "git config --global http.proxy $fake_proxy"
fi


# set proxy discovery
# in the file, find the lie ProxyType=\d and set it to ProxyType=3
# 0 - no proxy
# 3 - autodetect
kioslaverc_file="$HOME/.config/kioslaverc"
sed -i 's/ProxyType=[0-9]/ProxyType=3/' "$kioslaverc_file"

