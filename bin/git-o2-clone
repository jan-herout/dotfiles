#!/usr/bin/env bash
# doc: Klonuje GitHub repo s automatickým nastavením PAT tokenu

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"
include "lib/git.sh"



# test if the curent dir is already agit repo, find .git
[ -d ".git" ] && fDie "current directory is already a git repo, bail out"


# path
PAT_FILE=$HOME/Vaults/o2/github/jan_herout_pat

# kontrola existence secrets souboru a mount vaultu
if [ ! -f "$PAT_FILE" ]; then
    printWarn "File does not exist: $PAT_FILE"
    cryfs $HOME/.local/share/plasma-vault/o2.enc $HOME/Vaults/o2/
fi

# pokud ani potom neexistuje, bail
[ ! -f "$PAT_FILE" ] && fDie "$ERR: File does not exist: $PAT_FILE"

# split the line into name and value, separator is space
GITHUB_TOKEN=$(cat $PAT_FILE | fzf)
GITHUB_TOKEN=$(echo $GITHUB_TOKEN | cut -d' ' -f2)
[[ -z "$GITHUB_TOKEN" ]] && fDie "No github token provided, bail out"


# test if the address is in clipboard
printInfo "Try to get address from the clipboard"
CLIPBOARD=$(xclip -o)

# test it the CLIPBOARD contains multiline string
if [[ $CLIPBOARD =~ $'\n' ]]; then
    CLIPBOARD=""    
fi
if [[ ! $CLIPBOARD =~ ^https:// ]]; then
    CLIPBOARD=""
fi
if [[ ! $CLIPBOARD =~ \.git$ ]]; then
    CLIPBOARD=""
fi
if [[ -z $CLIPBOARD ]]; then
    printWarn "clipboard does not contain a valid github address, please provide it manually"
else
    printSuccess "clipboard contains a valid github address: $CLIPBOARD"
fi

# ask the user what github address to clone
read -p "Enter the github address to clone, ENTER to use the default" GITHUB_ADDRESS
if [ -z "$GITHUB_ADDRESS" ]; then
    printInfo "No github address provided, using address from clipboard: $CLIPBOARD"
    GITHUB_ADDRESS=$CLIPBOARD
fi

# test that the address starts with https:// and engs with .git
[[ ! $GITHUB_ADDRESS =~ ^https:// ]] && fDie  "$ERR: Address does not start with https://"
[[ ! $GITHUB_ADDRESS =~ \.git$ ]] fDie "Address does not end with .git"
printSuccess "Github address provided: $GITHUB_ADDRESS"

# get the folder name from the address
FOLDER_NAME=$(echo $GITHUB_ADDRESS | sed 's/.*\/\([^\/]*\)\.git/\1/')
printSuccess "folder name: $FOLDER_NAME"

# check if the folder already exists
if [ -d "$FOLDER_NAME" ]; then
    printWarn "Folder already exists: $FOLDER_NAME"
    printWarn "Do you want to remove it? type in name of the folder to proceed"
    read -p "Enter name of the folder ($FOLDER_NAME) if it should be deleted: " REMOVE_FOLDER
    if [ "$REMOVE_FOLDER" == "$FOLDER_NAME" ]; then        
        rm -rf $FOLDER_NAME || fDie "Removal failed: $FOLDER_NAME"
        printSuccess "Folder $FOLDER_NAME removed"
    else
        fDie "Folder already exists, bail out"
    fi
fi



# the address is in the form: https://github.com/jan-herout_o2cz/test-repo.git
# we need it to be in the form https://$GITHUB_TOKEN@github.com/jan-herout_o2cz/test-repo.git
GITHUB_ADDRESS=${GITHUB_ADDRESS/https:\/\//https:\/\/$GITHUB_TOKEN@}

# read the address of the proxy server
O2_USERNAME=""
O2_PASSWORD=""
O2_USERNAME_FILE=$HOME/Vaults/o2/o2_username.txt
O2_PASSWORD_FILE=$HOME/Vaults/o2/o2_password.txt

if ! test -f $O2_USERNAME_FILE; then
  fDie "File does not exist: $O2_USERNAME_FILE"
fi

if ! test -f $O2_PASSWORD_FILE; then
  fDie "File does not exist: $O2_USERNAME_FILE"
fi


# clone the repo
printInfo "cloning the repo"
git \
    -c http.proxy=$http_proxy \
    clone $GITHUB_ADDRESS

if [ $? -ne 0 ]; then
    fDie "$ERR: failed to clone repo: $GITHUB_ADDRESS"
fi


prinHeader "Clone successfull"
printSuccess "ALL DONE: $FOLDER_NAME - see the tree"
tree -L 1 $FOLDER_NAME
