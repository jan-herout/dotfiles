#!/usr/bin/env bash
# doc: Kontroluje CONDUCTOR logy pro vybraný mart a engine

[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"


# produkce a mount point
MNT_FILE="$HOME/dotfiles/bin/net-mount-points/virt_node@prod"
source "$MNT_FILE" || fDie "Failed to source: $MNT_FILE"
findmnt $_MNT_ >/dev/null 2>&1
[ $? -ne 0 ] && fDie "not mounted: $_MNT_"


# vyber engine
PMROOTDIR=$(echo "PMRootDir_ASG
PMRootDir_A29" | fzf)
[[ -z "$PMROOTDIR" ]] && fDie "Empty selection: PMROOTDIR='$PMROOTDIR'"
PMWORKFLOWLOGDIR=$(echo $PMROOTDIR | sed s/PMRootDir/PMWorkflowLogDir/)

# vyber jeden mart
DEF_MASK="$_MNT_/EDW/$PMROOTDIR/py_mart_def/*.json"
MART=$(ls -1 $DEF_MASK | cut -d '/' -f 7  | sed  s/.json// | fzf --prompt "Vyber datamart")
[[ -z "$MART" ]] && fDie "Empty selection"

# pokud máš mart, projeď jeho historii
LOG_FILE=$(find "$_MNT_/EDW/$PMWORKFLOWLOGDIR" -maxdepth 1 -type f -name "*CONDUCTOR*" | head -n 1 )
[[ -z "$LOG_FILE" ]] && fDie "Nenašel jsem ani jeden log soubor jobu CONDUCTOR"

cat $LOG_FILE | grep $MART | grep -E 'next_run_dttm|missing|_restart_mart_starter_job|schedule' | batcat