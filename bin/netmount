#!/usr/bin/env bash
# doc: Připojí VPN a namountuje síťové disky s možností git fetch
[ "$(type -t include)" != 'function' ]&&{ include(){ { [ -z "$_IR" ]&&_IR="$PWD"&&cd "$(dirname "${BASH_SOURCE[0]}")"&&include "$1"&&cd "$_IR"&&unset _IR;}||{ local d="$PWD"&&cd "$(dirname "$PWD/$1")"&&. "$(basename "$1")"&&cd "$d";}||{ echo "Include failed $PWD->$1"&&exit 1;};};}
include "lib/user_io.sh"
include "lib/die.sh"

# tohle sice nesouvisí se sítí ale fakt mě to štve
amixer -c 1 set Headphone unmute

mount_points_def_dir=$HOME/bin/net-mount-points
domain_passfile=$HOME/Vaults/o2/domain-password.txt
vpn_client="/opt/cisco/anyconnect/bin/vpn"
vpn_client_ui="/opt/cisco/anyconnect/bin/vpnui"
src_cisco_path=$HOME/Vaults/o2/.cisco

what_to_do=$(echo "mount a git fetch
mount
jenom vpn" | fzf)

# mount the vault
$HOME/bin/vault -m
[[ -f "$domain_passfile" ]] || fDie "File does not exist: $domain_passfile"


# načti secrets a další
var_me=$(whoami)
var_uid=$(id -u $var_me)
var_gid=$(id -g $var_me)
var_pass=$(<$HOME/Vaults/o2/domain-password.txt)
[[ -z $var_pass ]] && fDie "failed to read domain password from $domain_passfile"
printInfo "secrets read sucessfully"

# test napojení na VPN
is_on_vpn=$(nmcli connection show --active | grep extvpn.o2.cz)

# CISCO # is_on_vpn=$(ps aux | grep vpnui | grep -v grep | awk ' { print $2 }')
if [[ -z "$is_on_vpn" ]]; then
    # CISCO # if [[ ! -d "$HOME/.cisco" ]]; then
    # CISCO #     flog "copy certificates: cp -r $src_cisco_path $HOME" warning
    # CISCO #     cp -r "$src_cisco_path" $HOME || fDie "copy failed!"
    # CISCO #     [[ -d "$HOME/.cisco" ]] || fDie "folder $HOME/.cisco does not exist!"
    # CISCO # fi

	printInfo "connecting to VPN"
	nmcli connection up extvpn.o2.cz 1>/dev/null 2>&1 || fDie "failed to connect"
    # CISCO # # lepší přes GUI $vpn_client connect extvpn.o2.cz || fDie "failed to connect"
    # CISCO # $vpn_client_ui >/dev/null 2>&1 & 
    
    # infinite loop
    while true; do                 
        # CISCO # sleep 1
        # CISCO # vpn_state=$($vpn_client state | grep Connected | head -n 1 | awk '{print $4}')        
        # COSCO # if [[ "$vpn_state" =~ "Connected" ]]; then
        # COSCO #     flog "VPN is connected" info
        # COSCO #     break
        # COSCO # fi
        is_on_vpn=$(nmcli connection show --active | grep extvpn.o2.cz)
        if [[ -z "$is_on_vpn" ]]; then
            printInfo "waiting on VPN to connect..."
            sleep 1
        else
            break
        fi
    done 
    # [[ -f $HOME/Vaults/o2/after-connect.sh ]] && $HOME/Vaults/o2/after-connect.sh
else
    printSuccess "VPN is already connected"
fi



$HOME/bin/set-proxy-on
# set proxy discovery
# in the file, find the lie ProxyType=\d and set it to ProxyType=3
# 0 - no proxy
# 3 - autodetect
kioslaverc_file="$HOME/.config/kioslaverc"
sed -i 's/ProxyType=[0-9]/ProxyType=3/' "$kioslaverc_file"
if [[ $? -eq 0 ]]; then
    printSuccess "kde: $HOME/.config/kioslaverc: set ProxyType=3 (autodetect)"
else
    printError "ERR: kde: $HOME/.config/kioslaverc: set ProxyType=3 (autodetect)"
fi


# proveď mount
#if [ "${__MOUNT_DRIVES__^^}" = "Y" ]; then 
if [[ "$what_to_do" =~ "mount" ]]; then
    for mount_point in "$mount_points_def_dir"/*; do
        printInfo "read $mount_point"
        source $mount_point

        if [ -d "$_MNT_" ]; then
            findmnt $_MNT_ >/dev/null 2>&1
            if [ $? -eq 0 ]; then
                printWarn "directory is already mounted: $_MNT_"
            else
                printInfo "mounting $_SRC_" info
                MM_OPTIONS="domain=TO2,username=X0548834,"
                MM_OPTIONS+="password=$var_pass,"
                MM_OPTIONS+="uid=$var_uid,"
                MM_OPTIONS+="gid=$var_gid,"
                MM_OPTIONS+="dir_mode=0755,file_mode=0755"
                MM_OPTIONS+=$_SUFFIX_
                sudo mount -t cifs -o $MM_OPTIONS $_SRC_ $_MNT_

                if [[ $? -gt 0 ]]; then
                    printError "failed to mount $_SRC_"
                fi
            fi
        fi
    done
fi

# unmount the vault
$HOME/bin/vault -u

# odjeď git fetch
if [[ "$what_to_do" =~ "git" ]]; then
    $HOME/bin/git-o2-fetch
fi

