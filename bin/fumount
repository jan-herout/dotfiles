#!/bin/bash

source $HOME/bin/basic-func.sh
if [[ $? -ne 0 ]]; then
  echo "sourcing failed"
  exit 1
fi


MOUNT_POINT=$(ls /mnt | fzf --prompt="Vyber mount: ")
[[ -z "$MOUNT_POINT" ]] && fdie "No mount selected, bail out"

sudo umount "/mnt/$MOUNT_POINT"
if [ $? -eq 0 ]; then
    flog "Unmounted $MOUNT_POINT successfully" info
    exit 0
fi

flog "Error unmounting $MOUNT_POINT, find blocking pids" error

# PIDy
KILL_THESE=$(lsof \
    | grep '/mnt/ntbimetadata401-w-f' \
    | awk '{print $2}' \
    | xargs -I{} sh -c 'echo -n "PID: {} CMD: "; tr "\0" " " < /proc/{}/cmdline; echo' \
    | fzf --prompt="Select PID to kill (Shift+Tab to select multiple) ")

[[ -z "$KILL_THESE" ]] && fdie "no pids selected, bail out"

# read the selection and kill the PIDs, separator is \0 character
IFS=$'\0' read -r -a ITEMS <<< "$KILL_THESE"
for ITEM in "${ITEMS[@]}"; do
    # use cut to extract the PID from the selection
    PID=$(echo "$ITEM" | cut -d ' ' -f 2)
    
    if [[ -n "$PID" ]]; then
        kill -9 "$PID"
        if [[ $? -eq 0 ]]; then
            flog "PID $PID killed successfully" info
        else 
            flog "Error killing PID $PID" warning
        fi
    fi
done

# try again
sudo umount "/mnt/$MOUNT_POINT" || fdie "Error unmounting $MOUNT_POINT" 
flog "done"