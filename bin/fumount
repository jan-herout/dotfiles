#!/usr/bin/env bash
# doc: Umount CIFS s automatickým zabíjením blokujících procesů
[ "$(type -t include)" != 'function' ] && { include() { { [ -z "$_IR" ] && _IR="$PWD" && cd "$(dirname "${BASH_SOURCE[0]}")" && include "$1" && cd "$_IR" && unset _IR; } || { local d="$PWD" && cd "$(dirname "$PWD/$1")" && . "$(basename "$1")" && cd "$d"; } || { echo "Include failed $PWD->$1" && exit 1; }; }; }
include "lib/user_io.sh"
include "lib/die.sh"

MOUNT_POINT=$(mount | awk '{print $3}' | grep '/mnt' | fzf --prompt="Vyber mount: ")
[[ -z "$MOUNT_POINT" ]] && fDie "No mount selected, bail out"

sudo umount "$MOUNT_POINT"
if [ $? -eq 0 ]; then
  printInfo "Unmounted $MOUNT_POINT successfully"
  exit 0
fi

printError "Error unmounting $MOUNT_POINT, find blocking pids" error

# PIDy
KILL_THESE=$(lsof |
  grep "$MOUNT_POINT" |
  awk '{print $2}' |
  xargs -I{} sh -c 'echo -n "PID: {} CMD: "; tr "\0" " " < /proc/{}/cmdline; echo' |
  fzf --prompt="Select PID to kill (Shift+Tab to select multiple) ")

[[ -z "$KILL_THESE" ]] && fDie "no pids selected, bail out"

# read the selection and kill the PIDs, separator is \0 character
IFS=$'\0' read -r -a ITEMS <<<"$KILL_THESE"
for ITEM in "${ITEMS[@]}"; do
  # use cut to extract the PID from the selection
  PID=$(echo "$ITEM" | cut -d ' ' -f 2)

  if [[ -n "$PID" ]]; then
    kill -9 "$PID"
    if [[ $? -eq 0 ]]; then
      printSuccess "PID $PID killed successfully"
    else
      printError "Error killing PID $PID"
    fi
  fi
done

# try again
sudo umount "/mnt/$MOUNT_POINT" || fDie "Error unmounting $MOUNT_POINT"
printSuccess "done"
