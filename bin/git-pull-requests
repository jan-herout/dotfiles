#!/usr/bin/env bash
# doc: Zobrazuje pull requesty z GitHub API ve formátované tabulce

GIT_CONFIG_FILE=.git/config
if [ ! -f "$GIT_CONFIG_FILE" ]; then
    echo -e "$ERR: Git configuration file not found at $GIT_CONFIG_FILE"
    exit 1
fi

# Extract the remote URL from the git config
remote_url=$(grep -m1 'url =' "$GIT_CONFIG_FILE" | sed -E 's/.*url = //')
if [[ -z "$remote_url" ]]; then
  echo "No remote URL found in $GIT_CONFIG_FILE"
  exit 1
fi

# Extract the token between 'https://' and '@'
token=$(echo "$remote_url" | sed -nE 's#https://([^@]+)@.*#\1#p')
if [[ ! -n "$token" ]]; then
  echo "No token found in remote URL"
  exit 1
fi


PAT_TOKEN=$token
REPO_NAME=$(basename "$(pwd)")
REPO_URL="https://api.github.com/repos/o2cz-it-dev/$REPO_NAME/pulls"

if [[ -z "$REPO_URL" || -z "$PAT_TOKEN" ]]; then
  echo "Nemám token a nemám repo"
  exit 1
fi

pull_requests=$(curl -sL \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $PAT_TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  "$REPO_URL" | \
  jq -r '.[] | "\(.number) | \(.title) | \(.user.login) | \(.head.ref)"')

printf "%-38s | %-8s | %-48s | %s\n" "JIRA" "Autor" "MR & zdrojová feature branch" "subdir"
printf "%-38s | %-8s | %-48s | %s\n" "--------------------------------------" "--------" "------------------------------------------------" "----------------------------------------------------------------------------------"

# Process each pull request
while IFS='|' read -r id title author branch; do
  # Trim whitespace
  id=$(echo "$id" | xargs)
  title=$(echo "$title" | xargs)
  author=$(echo "$author" | xargs)
  branch=$(echo "$branch" | xargs)

  # Extract JIRA (BIDEV-xxxx or ND-xxxx)
  jira=$(echo "$title" | grep -oE 'BIDEV-[0-9]+' || echo "$title" | grep -oE 'ND-[0-9]+')
  if [[ -z "$jira" ]]; then
    jira="\`N/A\`"
  else
    jira="<https://jira.cz.o2/browse/$jira>"
  fi

  if [[ -z "$id" ]]; then
    id="\`N/A\`"
  else
    id="!$id"
  fi


  printf "%-38s | %-8s | %-48s | %s\n" "$jira" "$author" "$id - \`$branch\`" "$title"
done <<< "$pull_requests"